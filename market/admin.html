<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<meta name="robots" content="noindex,nofollow" />
<title>X5 Admin â€” å•†å“ & åº«å­˜æ§å°</title>
<style>
  :root{
    --bg:#0b0b0b;--panel:#111;--muted:#9aa0a6;--line:#222;--brand:#7c5cff;
    --ok:#22c55e;--warn:#f59e0b;--err:#ef4444;--text:#fff;
  }
  html,body{background:var(--bg);color:var(--text);font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
  *{box-sizing:border-box}
  .wrap{max-width:1080px;margin:24px auto;padding:0 16px}
  h1{font-weight:800;letter-spacing:.4px;margin:0 0 16px}
  .muted{color:var(--muted)}
  .row{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
  .card{background:var(--panel);border:1px solid var(--line);border-radius:14px;padding:16px;margin:12px 0}
  input,select,textarea,button{background:#0f0f0f;border:1px solid #2a2a2a;color:#fff;border-radius:10px;padding:8px 10px}
  input[type="number"]{width:120px}
  input[type="text"]{min-width:220px}
  textarea{width:100%;min-height:120px}
  button{cursor:pointer}
  button.primary{background:var(--brand);border-color:#6a52ff}
  button.ok{background:#15351f;border-color:#235e39;color:#b7ffcf}
  button.warn{background:#3a2a00;border-color:#6a5200;color:#ffd98a}
  button.ghost{background:#0d0d0d}
  .grid{width:100%;overflow:auto}
  table{width:100%;border-collapse:collapse}
  th,td{border-bottom:1px solid #1f1f1f;padding:8px 10px;text-align:left;vertical-align:middle}
  th{position:sticky;top:0;background:#121212;z-index:1}
  img.thumb{width:48px;height:48px;object-fit:cover;border-radius:9px;border:1px solid #222}
  .r{text-align:right}
  .center{text-align:center}
  .tag{display:inline-block;border:1px solid #2b2b2b;border-radius:20px;padding:2px 8px;font-size:12px;color:#bbb}
  .toolbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin:8px 0}
  .pill{padding:6px 10px;border-radius:999px;border:1px solid #2b2b2b;background:#121212}
  .flex1{flex:1}
  .toast{position:fixed;inset:auto 16px 16px auto;background:#111;border:1px solid #333;border-radius:12px;padding:10px 12px;color:#fff;opacity:0;transform:translateY(6px);transition:.2s}
  .toast.show{opacity:1;transform:translateY(0)}
  .status-dot{display:inline-block;width:8px;height:8px;border-radius:50%}
  .status-paid{background:var(--ok)} .status-pending{background:var(--warn)} .status-cancelled{background:var(--err)} .status-expired{background:#666}
  .nowrap{white-space:nowrap}
</style>
</head>
<body>
<div class="wrap">
  <h1>ğŸ› ï¸ X5 Admin <span class="muted">â€” å•†å“ & åº«å­˜æ§å°</span></h1>

  <!-- åŸºæœ¬è¨­å®š -->
  <div class="card">
    <div class="row">
      <label>å¾Œç«¯</label>
      <input id="base" placeholder="https://x5capital.onrender.com" size="34">
      <label>Token</label>
      <input id="token" type="password" placeholder="ADMIN_TOKEN" size="30">
      <button id="save" class="ghost">ä¿å­˜</button>
      <button id="ping" class="ghost">é€£ç·šæ¸¬è©¦</button>
      <span id="pingRes" class="muted"></span>
    </div>
    <div class="row" style="margin-top:8px">
      <button id="sweep" class="warn">æ¸…ç†é€¾æœŸè¨‚å–®ä¸¦å›è£œåº«å­˜</button>
      <button id="loadItems" class="ghost">é‡æ–°è¼‰å…¥å•†å“</button>
      <button id="loadOrders" class="ghost">æŸ¥çœ‹æœ€è¿‘è¨‚å–®</button>
      <span class="muted">â€» åªæœ‰å¸¶å° Token çš„è«‹æ±‚ï¼Œæ‰å‹•å¾—äº†è³‡æ–™ã€‚</span>
    </div>
  </div>

  <!-- å•†å“æ“ä½œå·¥å…·åˆ— -->
  <div class="card">
    <div class="toolbar">
      <input id="q" placeholder="æœå°‹åç¨± / ID / é¡åˆ¥" class="flex1">
      <select id="cat"><option value="">å…¨éƒ¨åˆ†é¡</option></select>
      <select id="sort">
        <option value="sort_order">æ’åºï¼šsort_order</option>
        <option value="title">æ’åºï¼šåç¨±</option>
        <option value="price_asc">åƒ¹æ ¼ï¼šä½â†’é«˜</option>
        <option value="price_desc">åƒ¹æ ¼ï¼šé«˜â†’ä½</option>
        <option value="stock_asc">åº«å­˜ï¼šä½â†’é«˜</option>
        <option value="stock_desc">åº«å­˜ï¼šé«˜â†’ä½</option>
      </select>
      <button id="export" class="ghost">åŒ¯å‡º JSON</button>
      <button id="toggleImport" class="ghost">åŒ¯å…¥ JSON</button>
      <button id="bulkPlus" class="ghost">é¸å– +1</button>
      <button id="bulkMinus" class="ghost">é¸å– âˆ’1</button>
      <button id="bulkSet" class="ghost">é¸å– è¨­åº«å­˜</button>
    </div>
    <div id="importBox" style="display:none;margin-top:8px">
      <textarea id="importArea" placeholder='[{"id":"sku-1","title":"å“å","price":99,"stock":10,"img":"...","category":"...","description":"...","sortOrder":10}]'></textarea>
      <div class="row">
        <button id="importDo" class="primary">ä¸Šå‚³ / æ›´æ–°</button>
        <span class="muted">â€» é€™æ˜¯é€ç­† Upsertï¼›éœ€è¦ Tokenã€‚</span>
      </div>
    </div>

    <div class="grid" style="margin-top:10px">
      <table id="itemsTable">
        <thead>
          <tr>
            <th style="width:28px"><input type="checkbox" id="chkAll"></th>
            <th>åœ–ç‰‡</th>
            <th>ID</th>
            <th>åç¨±</th>
            <th>é¡åˆ¥</th>
            <th class="r">åƒ¹æ ¼</th>
            <th class="r">åº«å­˜</th>
            <th>æ’åº</th>
            <th class="center">æ“ä½œ</th>
          </tr>
        </thead>
        <tbody id="itemsBody"><tr><td colspan="9" class="muted">è¼‰å…¥ä¸­â€¦</td></tr></tbody>
      </table>
    </div>
  </div>

  <!-- æ–°å¢ / æ›´æ–° å•†å“ -->
  <div class="card">
    <h3 style="margin-top:0">æ–°å¢ / æ›´æ–°å•†å“</h3>
    <div class="row" style="gap:14px">
      <input id="f_id" placeholder="idï¼ˆå”¯ä¸€ï¼‰" />
      <input id="f_title" placeholder="titleï¼ˆåç¨±ï¼‰" />
      <input id="f_category" placeholder="categoryï¼ˆåˆ†é¡ï¼‰" />
      <input id="f_price" type="number" step="0.01" placeholder="price" />
      <input id="f_stock" type="number" step="1" placeholder="stock" />
      <input id="f_sort" type="number" step="1" placeholder="sortOrder" />
      <input id="f_img" placeholder="img URL" size="40" />
      <button id="upsert" class="primary">Upsert</button>
    </div>
    <div class="row" style="margin-top:8px">
      <textarea id="f_desc" placeholder="descriptionï¼ˆå•†å“èªªæ˜ï¼Œå¯å¤šè¡Œï¼‰"></textarea>
    </div>
  </div>

  <!-- æœ€è¿‘è¨‚å–® -->
  <div class="card">
    <div class="row">
      <h3 style="margin:0">æœ€è¿‘è¨‚å–®</h3>
      <span id="ordersInfo" class="muted"></span>
    </div>
    <div class="grid">
      <table>
        <thead>
          <tr>
            <th>ç‹€æ…‹</th><th>ç·¨è™Ÿ</th><th>è³‡ç”¢</th><th class="r">é‡‘é¡</th><th>å»ºç«‹</th><th>é€¾æœŸ</th><th class="center">æ“ä½œ</th>
          </tr>
        </thead>
        <tbody id="ordersBody"><tr><td colspan="7" class="muted">å°šæœªè¼‰å…¥</td></tr></tbody>
      </table>
    </div>
  </div>
</div>

<div id="toast" class="toast"></div>

<script>
/* ========= å°å·¥å…· ========= */
const $ = (s, d=document)=>d.querySelector(s);
const $$ = (s, d=document)=>Array.from(d.querySelectorAll(s));
const toast = (m)=>{ const t=$('#toast'); t.textContent=m; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),1600); };
const money = (n)=>Number(n||0).toFixed(2);
const H = ()=>{ const h={'Content-Type':'application/json'}; const t=($('#token').value||'').trim(); if(t) h['x-admin-token']=t; return h; };
const BASE = ()=>($('#base').value||'').trim().replace(/\/+$/,'');
const j = async (url, init)=>{ const r = await fetch(url, init); if(!r.ok){ throw new Error((await r.text())||('HTTP '+r.status)); } return r.json(); };

const state = { items:[], filtered:[], orders:[] };

/* ========= è¨­å®šå€ ========= */
const LS_BASE='x5_admin_base', LS_TOKEN='x5_admin_token';
$('#base').value = localStorage.getItem(LS_BASE) || 'https://x5capital.onrender.com';
$('#token').value = localStorage.getItem(LS_TOKEN) || '';

$('#save').onclick = ()=>{ localStorage.setItem(LS_BASE, BASE()); localStorage.setItem(LS_TOKEN, ($('#token').value||'').trim()); toast('å·²ä¿å­˜'); };
$('#ping').onclick = async ()=>{
  try { const r = await fetch(BASE() + '/items'); const ok = r.ok; $('#pingRes').textContent = ok ? 'âœ… OK' : 'âŒ ' + r.status; }
  catch(e){ $('#pingRes').textContent = 'âŒ é€£ç·šå¤±æ•—'; }
};

/* ========= å•†å“ CRUD ========= */
async function loadItems(){
  $('#itemsBody').innerHTML = '<tr><td colspan="9" class="muted">è¼‰å…¥ä¸­â€¦</td></tr>';
  const data = await j(BASE()+'/items', { method:'GET' });
  state.items = data.items || [];
  renderCats();
  filterAndRender();
}
function renderCats(){
  const catSel = $('#cat');
  const cats = Array.from(new Set(state.items.map(i=>i.category).filter(Boolean))).sort();
  catSel.innerHTML = '<option value="">å…¨éƒ¨åˆ†é¡</option>' + cats.map(c=>`<option value="${c}">${c}</option>`).join('');
}

/* æœå°‹ + æ’åº + æ¸²æŸ“è¡¨æ ¼ */
function filterAndRender(){
  const q = ($('#q').value||'').toLowerCase().trim();
  const cat = $('#cat').value||'';
  const sort = $('#sort').value||'sort_order';
  let arr = state.items.filter(it=>{
    const hit = (it.title||'').toLowerCase().includes(q) || (it.id||'').toLowerCase().includes(q) || (it.category||'').toLowerCase().includes(q);
    const okc = !cat || (it.category||'')===cat;
    return hit && okc;
  });
  if (sort==='price_asc')   arr.sort((a,b)=>a.price-b.price);
  else if (sort==='price_desc') arr.sort((a,b)=>b.price-a.price);
  else if (sort==='stock_asc')  arr.sort((a,b)=>a.stock-b.stock);
  else if (sort==='stock_desc') arr.sort((a,b)=>b.stock-a.stock);
  else if (sort==='title')      arr.sort((a,b)=>String(a.title).localeCompare(String(b.title)));
  else                          arr.sort((a,b)=>(a.sort_order??0)-(b.sort_order??0));
  state.filtered = arr;
  renderItemsTable(arr);
}

function renderItemsTable(items){
  const tb = $('#itemsBody');
  if (!items.length){ tb.innerHTML='<tr><td colspan="9" class="muted">æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„å•†å“</td></tr>'; return; }
  tb.innerHTML = items.map(it=>`
    <tr data-id="${it.id}">
      <td class="center"><input type="checkbox" data-sel></td>
      <td><img class="thumb" src="${it.img||''}" onerror="this.src='https://i.ibb.co/k2H7kfrt/Newx5logo-1.png'"></td>
      <td class="nowrap"><code>${it.id}</code></td>
      <td><input data-edit="title" value="${it.title||''}" style="min-width:220px"></td>
      <td><input data-edit="category" value="${it.category||''}" style="min-width:120px"></td>
      <td class="r"><input data-edit="price" type="number" step="0.01" value="${money(it.price)}" style="width:120px"></td>
      <td class="r"><strong id="stk-${it.id}">${it.stock??0}</strong></td>
      <td><input data-edit="sort_order" type="number" step="1" value="${it.sort_order??''}" style="width:100px"></td>
      <td class="center">
        <button data-act="adj" data-delta="-1">âˆ’1</button>
        <button data-act="adj" data-delta="1">+1</button>
        <input data-set="qty" type="number" step="1" placeholder="set" style="width:90px">
        <button data-act="apply">å¥—ç”¨</button>
        <button data-act="save" class="primary">å„²å­˜</button>
      </td>
    </tr>
  `).join('');
}

$('#itemsBody').addEventListener('click', async (e)=>{
  const tr = e.target.closest('tr[data-id]'); if(!tr) return;
  const id = tr.dataset.id;
  const act = e.target.dataset.act;

  try{
    if (act==='adj'){
      const delta = Number(e.target.dataset.delta||0);
      const r = await j(`${BASE()}/items/${encodeURIComponent(id)}/adjust`, { method:'POST', headers:H(), body: JSON.stringify({ delta }) });
      tr.querySelector(`#stk-${id}`).textContent = r.item.stock;
      toast('å·²æ›´æ–°åº«å­˜');
      await loadItems();
    }
    if (act==='apply'){
      const qty = Number(tr.querySelector('input[data-set="qty"]').value||0);
      const r = await j(`${BASE()}/items/${encodeURIComponent(id)}/set-stock`, { method:'POST', headers:H(), body: JSON.stringify({ stock: qty }) });
      tr.querySelector(`#stk-${id}`).textContent = r.item.stock;
      toast('å·²è¨­å®šåº«å­˜');
      await loadItems();
    }
    if (act==='save'){
      const body = readInlineEdits(tr, id);
      await j(`${BASE()}/items/upsert`, { method:'POST', headers:H(), body: JSON.stringify(body) });
      toast('å·²å„²å­˜');
      await loadItems();
    }
  }catch(err){ toast(err.message); }
});

function readInlineEdits(tr, id){
  const g = (sel)=>tr.querySelector(`[data-edit="${sel}"]`)?.value ?? '';
  const price = Number(g('price')||0);
  const sort  = g('sort_order')==='' ? null : Number(g('sort_order'));
  const category = g('category')||null;
  const title = g('title')||'æœªå‘½å';
  const img = state.items.find(x=>x.id===id)?.img || '';
  const description = state.items.find(x=>x.id===id)?.description || '';
  return { id, title, category, price, img, description, sortOrder: sort };
}

/* å…¨é¸ / æ‰¹æ¬¡èª¿æ•´ */
$('#chkAll').onchange = ()=>$$('#itemsBody input[type="checkbox"][data-sel]').forEach(x=>x.checked=$('#chkAll').checked);
const selectedIds = ()=>$$('#itemsBody tr[data-id]').filter(tr=>tr.querySelector('input[data-sel]').checked).map(tr=>tr.dataset.id);
$('#bulkPlus').onclick  = ()=>bulkAdjust(+1);
$('#bulkMinus').onclick = ()=>bulkAdjust(-1);
$('#bulkSet').onclick   = async ()=>{
  const ids = selectedIds(); if(!ids.length) return toast('è«‹å…ˆå‹¾é¸å•†å“');
  const qty = Number(prompt('è¦æŠŠåº«å­˜è¨­ç‚ºå¹¾ï¼Ÿ','0')||'0');
  for (const id of ids){
    try{ await j(`${BASE()}/items/${encodeURIComponent(id)}/set-stock`, { method:'POST', headers:H(), body: JSON.stringify({ stock: qty }) }); }
    catch(e){ toast(`${id}: ${e.message}`); }
  }
  toast('æ‰¹æ¬¡è¨­å®šå®Œæˆ'); await loadItems();
};
async function bulkAdjust(delta){
  const ids = selectedIds(); if(!ids.length) return toast('è«‹å…ˆå‹¾é¸å•†å“');
  for (const id of ids){
    try{ await j(`${BASE()}/items/${encodeURIComponent(id)}/adjust`, { method:'POST', headers:H(), body: JSON.stringify({ delta }) }); }
    catch(e){ toast(`${id}: ${e.message}`); }
  }
  toast('æ‰¹æ¬¡èª¿æ•´å®Œæˆ'); await loadItems();
}

/* æ–°å¢ / æ›´æ–° å•†å“è¡¨å–® */
$('#upsert').onclick = async ()=>{
  const body = {
    id: $('#f_id').value.trim(),
    title: $('#f_title').value.trim(),
    description: $('#f_desc').value,
    category: $('#f_category').value.trim() || null,
    price: Number($('#f_price').value||0),
    stock: Number($('#f_stock').value||0),
    img: $('#f_img').value.trim() || null,
    sortOrder: ($('#f_sort').value===''? null : Number($('#f_sort').value))
  };
  if (!body.id || !body.title) return toast('id / title å¿…å¡«');
  try{
    await j(`${BASE()}/items/upsert`, { method:'POST', headers:H(), body: JSON.stringify(body) });
    toast('å·²ä¸Šæ¶ / æ›´æ–°');
    clearForm(); await loadItems();
  }catch(err){ toast(err.message); }
};
function clearForm(){ ['f_id','f_title','f_desc','f_category','f_price','f_stock','f_img','f_sort'].forEach(id=>$('#'+id).value=''); }

/* åŒ¯å‡º / åŒ¯å…¥ JSON */
$('#export').onclick = ()=>{
  const blob = new Blob([JSON.stringify(state.filtered, null, 2)], {type:'application/json'});
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'items.json'; a.click();
};
$('#toggleImport').onclick = ()=>{ const b=$('#importBox'); b.style.display = b.style.display==='none' ? 'block' : 'none'; };
$('#importDo').onclick = async ()=>{
  let arr = []; try{ arr = JSON.parse($('#importArea').value||'[]'); }catch{ return toast('JSON è§£æå¤±æ•—'); }
  if (!Array.isArray(arr) || !arr.length) return toast('æ²’æœ‰è³‡æ–™');
  for (const it of arr){
    const body = {
      id: it.id, title: it.title || it.name || 'æœªå‘½å',
      description: it.description || it.desc || '',
      category: it.category || null,
      price: Number(it.price || it.price_usdt || 0),
      stock: Number(it.stock || 0),
      img: it.img || it.image || null,
      sortOrder: (it.sortOrder ?? it.sort_order ?? null)
    };
    try{ await j(`${BASE()}/items/upsert`, { method:'POST', headers:H(), body: JSON.stringify(body) }); }
    catch(e){ toast(`${body.id}: ${e.message}`); }
  }
  toast('æ‰¹æ¬¡ä¸Šå‚³å®Œæˆ'); $('#importArea').value=''; await loadItems();
};

/* ========= è¨‚å–® ========= */
async function loadOrders(){
  $('#ordersBody').innerHTML = '<tr><td colspan="7" class="muted">è¼‰å…¥ä¸­â€¦</td></tr>';
  try{
    const rows = await j(BASE()+'/orders/debug-latest', { method:'GET' });
    state.orders = rows;
    $('#ordersInfo').textContent = `å…± ${rows.length} ç­† (æœ€è¿‘)`;
    renderOrders();
  }catch(e){ $('#ordersBody').innerHTML = '<tr><td colspan="7" class="muted">è®€å–å¤±æ•—</td></tr>'; }
}
function renderOrders(){
  const tb = $('#ordersBody');
  if (!state.orders.length){ tb.innerHTML='<tr><td colspan="7" class="muted">å°šç„¡è³‡æ–™</td></tr>'; return; }
  tb.innerHTML = state.orders.map(o=>{
    const st = String(o.status||'').toLowerCase();
    const dot = `<span class="status-dot status-${st}" title="${st}"></span>`;
    return `<tr>
      <td class="nowrap">${dot} ${st}</td>
      <td class="nowrap"><code>${o.id}</code></td>
      <td>${o.asset||''}</td>
      <td class="r">${money(o.amount)}</td>
      <td class="nowrap">${(o.created_at||'').replace('T',' ').replace('Z','')}</td>
      <td class="nowrap">${(o.expires_at||'').replace('T',' ').replace('Z','')}</td>
      <td class="center">
        ${st==='pending' ? `<button data-cancel="${o.id}" class="warn">å–æ¶ˆ</button>` : '<span class="muted">â€”</span>'}
      </td>
    </tr>`;
  }).join('');
}
$('#ordersBody').addEventListener('click', async (e)=>{
  const id = e.target.dataset.cancel; if(!id) return;
  if(!confirm('ç¢ºå®šå–æ¶ˆè¨‚å–®ä¸¦å›è£œåº«å­˜ï¼Ÿ')) return;
  try{ await j(`${BASE()}/orders/${encodeURIComponent(id)}/cancel`, { method:'POST', headers:H() }); toast('å·²å–æ¶ˆ'); await loadOrders(); await loadItems(); }
  catch(err){ toast(err.message); }
});

/* ========= é€¾æœŸæ¸…ç† ========= */
$('#sweep').onclick = async ()=>{
  try{ const r = await j(BASE()+'/orders/sweep-expired', { method:'POST', headers:H() }); toast(`å·²æ¸…ç†é€¾æœŸï¼š${r.expired||0} ç­†`); await loadItems(); await loadOrders(); }
  catch(err){ toast(err.message); }
};

/* ========= æœå°‹ & æ§åˆ¶ ========= */
$('#q').oninput = filterAndRender;
$('#cat').onchange = filterAndRender;
$('#sort').onchange = filterAndRender;
$('#loadItems').onclick = loadItems;
$('#loadOrders').onclick = loadOrders;

/* ========= å•Ÿå‹• ========= */
loadItems().catch(()=>{});
</script>
</body>
</html>
