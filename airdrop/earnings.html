<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>收益日曆</title>
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <meta name="color-scheme" content="dark" />
  <style>
    html,body{height:100%}
    :root { color-scheme: dark; }
    select { color-scheme: dark; }
    select, option {
    background-color: #0b0b0b; /* ≈ bg-neutral-950 */
    color: #f1f5f9;            /* ≈ text-slate-100 */
    border-color: rgba(255,255,255,.1);
  }
  </style>
</head>
<body class="bg-neutral-950 text-neutral-100">
  <div id="root"></div>

  <script type="text/babel" data-presets="react">
    /* global React */
    const { useEffect, useMemo, useState, useRef } = React;

    const BRAND = { name: "Airdrop", logo: "https://i.ibb.co/q3DYk2jr/Newx5logo.png" };
    const STORAGE_KEY = "x5_earnings_v1";

    // ====== Utils ======
    const pad = (n) => String(n).padStart(2, "0");
    const isoDate = (y,m,d) => `${y}-${pad(m)}-${pad(d)}`;
    const todayISO = () => {
      const d = new Date(); return isoDate(d.getFullYear(), d.getMonth()+1, d.getDate());
    };
    const startOfMonth = (y,m) => new Date(y, m-1, 1);
    const endOfMonth = (y,m) => new Date(y, m, 0);
    const firstWeekday = (y,m) => startOfMonth(y,m).getDay(); // 0 Sun
    const daysInMonth = (y,m) => endOfMonth(y,m).getDate();

    function useLocalStorage(key, initial){
      const [value, setValue] = useState(()=>{
        try{ const raw = localStorage.getItem(key); return raw? JSON.parse(raw): initial; }catch{ return initial; }
      });
      useEffect(()=>{
        try{ localStorage.setItem(key, JSON.stringify(value)); }catch{}
      }, [key, value]);
      return [value, setValue];
    }

    // ====== Types ======
    // Entry: { id, date:'YYYY-MM-DD', type: 'income'|'expense', amount:number, asset?:string, note?:string }

    // ====== Calendar Page ======
    function Page(){
      const [entries, setEntries] = useLocalStorage(STORAGE_KEY, []);
      const now = new Date();
      const [year, setYear] = useState(now.getFullYear());
      const [month, setMonth] = useState(now.getMonth()+1);
      const [activeDate, setActiveDate] = useState(todayISO());
      const [showPanel, setShowPanel] = useState(false);
      const [menuOpen, setMenuOpen] = useState(false);
      const menuRef = useRef(null);

      useEffect(()=>{
        const onClick = (e)=>{ if(menuRef.current && !menuRef.current.contains(e.target)) setMenuOpen(false); };
        window.addEventListener('click', onClick);
        return ()=> window.removeEventListener('click', onClick);
      },[]);

      const monthKey = `${year}-${pad(month)}`;
      const monthEntries = useMemo(()=> entries.filter(e => e.date.startsWith(monthKey)), [entries, monthKey]);

      const monthStats = useMemo(()=>{
        let income = 0, expense = 0;
        for (const e of monthEntries){
          if (e.type === 'income') income += Number(e.amount)||0;
          else expense += Number(e.amount)||0;
        }
        return { income, expense, net: income - expense };
      }, [monthEntries]);

      function prevMonth(){
        const d = new Date(year, month-2, 1);
        setYear(d.getFullYear()); setMonth(d.getMonth()+1);
      }
      function nextMonth(){
        const d = new Date(year, month, 1);
        setYear(d.getFullYear()); setMonth(d.getMonth()+1);
      }

      function openDate(y,m,d){
        const iso = isoDate(y,m,d);
        setActiveDate(iso);
        setShowPanel(true);
      }

      function addEntry(payload){
        const id = `e_${Date.now()}_${Math.random().toString(36).slice(2,7)}`;
        setEntries(prev => [{ id, ...payload }, ...prev]);
      }
      function removeEntry(id){
        setEntries(prev => prev.filter(e => e.id !== id));
      }

      function exportJSON(){
        const blob = new Blob([JSON.stringify(entries, null, 2)], { type: "application/json;charset=utf-8" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href=url; a.download='earnings.json'; a.click(); URL.revokeObjectURL(url);
      }
      function exportCSV(){
        const header = ["date","type","amount","asset","note"];
        const rows = entries.map(e => [e.date, e.type, e.amount, e.asset||"", (e.note||"").replace(/"/g,'""')]);
        const csv = [header, ...rows].map(r=> r.map(v=> `"${v}"`).join(",")).join("\n");
        const blob = new Blob([csv], { type: "text/csv;charset=utf-8" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href=url; a.download='earnings.csv'; a.click(); URL.revokeObjectURL(url);
      }
      function importJSON(file){
        const reader = new FileReader();
        reader.onload = ()=>{
          try{
            const arr = JSON.parse(reader.result);
            if(!Array.isArray(arr)) throw new Error("JSON 應為陣列");
            // 合併 + 去重
            const map = new Map();
            for (const e of [...entries, ...arr]){
              const id = e.id || `imp_${e.date}_${Math.random().toString(36).slice(2,7)}`;
              map.set(id, { id, date:e.date, type:e.type==='expense'?'expense':'income', amount:Number(e.amount)||0, asset:e.asset||'', note:e.note||'' });
            }
            setEntries(Array.from(map.values()));
            alert("匯入完成");
          }catch(err){ alert("匯入失敗：" + err.message); }
        };
        reader.readAsText(file);
      }
      function openImport(){
        const inp = document.createElement('input');
        inp.type = 'file'; inp.accept = 'application/json';
        inp.onchange = e => { const f = e.target.files?.[0]; if (f) importJSON(f); };
        inp.click();
      }

      // 日曆格
      const first = firstWeekday(year, month);   // 0(日)~6(六)
      const days = daysInMonth(year, month);
      const cells = [];
      // 前置空白
      for (let i=0;i<first;i++) cells.push({ type:'blank', key:`b${i}` });
      // 當月日期
      for (let d=1; d<=days; d++){
        const date = isoDate(year, month, d);
        const list = entries.filter(e => e.date === date);
        const inc = list.filter(e=>e.type==='income').reduce((s,e)=>s+Number(e.amount||0),0);
        const exp = list.filter(e=>e.type==='expense').reduce((s,e)=>s+Number(e.amount||0),0);
        cells.push({ type:'day', d, date, inc, exp, list, key:`d${d}` });
      }
      // 後置補滿 7 的倍數
      while (cells.length % 7 !== 0) cells.push({ type:'blank', key:`t${cells.length}` });

      return (
        <div className="min-h-screen">
          <header className="sticky top-0 z-30 backdrop-blur border-b border-white/10 bg-neutral-950/70">
            <div className="mx-auto max-w-7xl px-4 py-3 flex items-center gap-3">
              <a href="./index.html" className="flex items-center gap-2">
                <img src={BRAND.logo} alt="logo" className="h-7 w-7 rounded"/>
                <span className="hidden sm:block text-sm font-semibold">{BRAND.name}</span>
              </a>
              <div className="ml-auto flex items-center gap-2">
                <button onClick={prevMonth} className="px-2 py-1 rounded-lg bg-white/10 border border-white/10 hover:bg-white/20">←</button>
                <div className="px-3 py-1.5 rounded-lg border border-white/10 bg-white/5 text-sm">{year} / {pad(month)}</div>
                <button onClick={nextMonth} className="px-2 py-1 rounded-lg bg-white/10 border border-white/10 hover:bg-white/20">→</button>

                {/* 工具下拉 */}
                <div className="relative" ref={menuRef}>
                  <button onClick={()=>setMenuOpen(!menuOpen)} className="ml-2 inline-flex items-center gap-1 px-3 py-1.5 rounded-xl text-sm bg-white/10 hover:bg-white/20 border border-white/10">
                    工具
                    <svg width="14" height="14" viewBox="0 0 24 24" className={"transition " + (menuOpen?"rotate-180":"")}><path fill="currentColor" d="M7 10l5 5 5-5z"/></svg>
                  </button>
                  {menuOpen && (
                    <div className="absolute right-0 mt-2 min-w-[180px] rounded-xl border border-white/10 bg-neutral-900 shadow-lg overflow-hidden z-50">
                      <button className="w-full text-left px-3 py-2 text-sm hover:bg-white/10" onClick={()=>{ setMenuOpen(false); exportJSON(); }}>匯出 JSON</button>
                      <button className="w-full text-left px-3 py-2 text-sm hover:bg-white/10" onClick={()=>{ setMenuOpen(false); exportCSV(); }}>匯出 CSV</button>
                      <div className="border-t border-white/10"></div>
                      <button className="w-full text-left px-3 py-2 text-sm hover:bg-white/10" onClick={()=>{ setMenuOpen(false); openImport(); }}>匯入 JSON</button>
                    </div>
                  )}
                </div>

                <a href="./index.html" className="px-3 py-1.5 rounded-xl text-sm bg-white/10 hover:bg-white/20 border border-white/10">返回任務廣場</a>
              </div>
            </div>
          </header>

          <main className="mx-auto max-w-7xl px-4 py-6">
            {/* 月統計 */}
            <div className="mb-4 flex flex-wrap items-center gap-3">
              <div className="px-3 py-1.5 rounded-xl bg-emerald-500/20 text-emerald-200 border border-emerald-400/30 text-sm">本月收入：{monthStats.income}</div>
              <div className="px-3 py-1.5 rounded-xl bg-rose-500/20 text-rose-200 border border-rose-400/30 text-sm">本月支出：{monthStats.expense}</div>
              <div className="px-3 py-1.5 rounded-xl bg-white/10 text-white border border-white/20 text-sm">淨額：{monthStats.net}</div>
            </div>

            {/* 週標題 */}
            <div className="grid grid-cols-7 text-xs text-neutral-400 mb-1">
              {["日","一","二","三","四","五","六"].map(w => <div key={w} className="px-2 py-1">{w}</div>)}
            </div>

            {/* 日曆格子 */}
            <div className="grid grid-cols-7 gap-1">
              {cells.map(cell => cell.type === 'blank' ? (
                <div key={cell.key} className="rounded-xl border border-transparent px-2 py-3" />
              ) : (
                <button key={cell.key} onClick={()=>openDate(year,month,cell.d)} className="text-left rounded-xl bg-white/5 border border-white/10 hover:bg-white/10 px-2 py-2 min-h-[80px]">
                  <div className="flex items-center justify-between mb-1">
                    <div className="text-xs text-neutral-400">{pad(cell.d)}</div>
                    {cell.date === todayISO() && <span className="text-[10px] px-1.5 py-0.5 rounded bg-gradient-to-r from-indigo-500 via-violet-500 to-fuchsia-500 text-white">Today</span>}
                  </div>
                  <div className="space-y-1">
                    {cell.inc>0 && <div className="text-xs text-emerald-300">＋{cell.inc}</div>}
                    {cell.exp>0 && <div className="text-xs text-rose-300">－{cell.exp}</div>}
                  </div>
                </button>
              ))}
            </div>
          </main>

          {/* 側邊面板：某一天的記錄 */}
          {showPanel && (
            <DayPanel
              date={activeDate}
              entries={entries.filter(e=>e.date===activeDate)}
              onClose={()=>setShowPanel(false)}
              onAdd={(e)=>addEntry(e)}
              onDelete={removeEntry}
            />
          )}

          <footer className="mx-auto max-w-7xl px-4 pb-10 text-sm text-neutral-500">
            <div className="border-t border-white/10 pt-6 flex items-center justify-between">
              <div>© {new Date().getFullYear()} X5 Capital. All rights reserved.</div>
              <div className="opacity-80">Local-only demo</div>
            </div>
          </footer>
        </div>
      );
    }

    function DayPanel({ date, entries, onAdd, onDelete, onClose }){
      const [type, setType] = useState('income');
      const [amount, setAmount] = useState('');
      const [asset, setAsset] = useState('');
      const [note, setNote] = useState('');
      const totals = entries.reduce((s,e)=> (e.type==='income' ? (s.inc+=Number(e.amount)||0) : (s.exp+=Number(e.amount)||0), s), {inc:0,exp:0});

      function submit(e){
        e.preventDefault();
        if(!amount) return;
        onAdd({ date, type, amount:Number(amount), asset, note });
        setAmount(''); setAsset(''); setNote('');
      }
      return (
        <div className="fixed inset-0 z-50 bg-black/60 backdrop-blur flex items-center justify-end" onClick={(e)=>{ if(e.target===e.currentTarget) onClose(); }}>
          <div className="w-full max-w-[420px] h-full overflow-auto bg-neutral-900 border-l border-white/10">
            <div className="p-4 border-b border-white/10 flex items-center justify-between">
              <div className="font-semibold">記錄：{date}</div>
              <button onClick={onClose} className="text-neutral-400 hover:text-white text-xl">✕</button>
            </div>
            <div className="p-4 space-y-4">
              <form onSubmit={submit} className="rounded-2xl border border-white/10 bg-white/5 p-3 space-y-2">
                <div className="grid grid-cols-2 gap-2">
                  <select value={type} onChange={e=>setType(e.target.value)} className="appearance-none rounded-xl bg-white/5 border border-white/10 px-3 py-2 pr-8 text-sm hover:bg-white/10"
                                                                             style={{ colorScheme: 'dark' }}>
                    <option value="income">收入</option>
                    <option value="expense">支出</option>
                  </select>
                  <svg className="pointer-events-none absolute right-2 top-1/2 -translate-y-1/2 opacity-70" width="14" height="14" viewBox="0 0 24 24">
                  <path fill="currentColor" d="M7 10l5 5 5-5z"/>
                  </svg>
                  <input value={amount} onChange={e=>setAmount(e.target.value)} type="number" step="any" placeholder="金額" className="rounded-xl bg-white/5 border border-white/10 px-3 py-2 text-sm" />
                </div>
                <div className="grid grid-cols-2 gap-2">
                  <input value={asset} onChange={e=>setAsset(e.target.value)} placeholder="資產/幣別（選填）" className="rounded-xl bg-white/5 border border-white/10 px-3 py-2 text-sm" />
                  <input value={note} onChange={e=>setNote(e.target.value)} placeholder="備註（選填）" className="rounded-xl bg-white/5 border border-white/10 px-3 py-2 text-sm" />
                </div>
                <button type="submit" className="w-full px-3 py-2 rounded-xl bg-white text-black text-sm">新增記錄</button>
              </form>

              <div className="flex items-center gap-2 text-sm">
                <div className="px-3 py-1.5 rounded-xl bg-emerald-500/20 text-emerald-200 border border-emerald-400/30">當日收入：{totals.inc}</div>
                <div className="px-3 py-1.5 rounded-xl bg-rose-500/20 text-rose-200 border border-rose-400/30">當日支出：{totals.exp}</div>
                <div className="px-3 py-1.5 rounded-xl bg-white/10 text-white border border-white/20">淨：{totals.inc - totals.exp}</div>
              </div>

              <div className="rounded-2xl border border-white/10 overflow-hidden">
                {entries.length === 0 ? (
                  <div className="p-4 text-sm text-neutral-400 text-center">這天還沒有記錄</div>
                ) : entries.map(e=>(
                  <div key={e.id} className="p-3 border-b border-white/10 last:border-0 flex items-center gap-3">
                    <span className={"px-2 py-0.5 rounded text-[11px] border " + (e.type==='income' ? "bg-emerald-500/20 text-emerald-200 border-emerald-400/30" : "bg-rose-500/20 text-rose-200 border-rose-400/30")}>
                      {e.type==='income' ? "收入" : "支出"}
                    </span>
                    <div className="flex-1 min-w-0">
                      <div className="text-sm">{e.amount} {e.asset || ""}</div>
                      {e.note && <div className="text-xs text-neutral-400 truncate">{e.note}</div>}
                    </div>
                    <button onClick={()=>onDelete(e.id)} className="text-sm text-rose-300 hover:text-rose-200">刪除</button>
                  </div>
                ))}
              </div>
            </div>
          </div>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<Page />);

    document.addEventListener('DOMContentLoaded', ()=> {
      const el = document.getElementById('yy');
      if (el) el.textContent = new Date().getFullYear();
    });
  </script>
</body>
</html>
